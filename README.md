# Проектная работа "Веб-ларек"
Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка
```
npm run build
```

или

```
yarn build
```
## Данные и типы данных
Данные товара
```
interface IProduct {
  id: string;
  title: string;
  price: number | null;
  image: string;
  category: string;
  description: string;
}
```

Данные покупателя
```
interface ICustomerData extends IInputFormData {
  payment: payment;
}
```

```
interface IInputFormData {
  address: string;
  email: string;
  phone: string;
}
```

Данные заказа
```
interface IOrder extends ICustomerData {
  items: string[];
  total: number;
}
```

## Архитектура приложения
В проекте реализована парадигма MVP, согласно которой:
- слой данных отвечает за работу с данными,
- слой представления отвечает за отображение данных на странице,
- презентер отвечает за взаимодействие слоев данных и представления, используя событийный брокер, 
который позволяет независимым слоям обмениваться сообщениями
- также есть коммуникационный слой в виде Api-классов, который позволяет обмениваться данными с другими приложениями

### Базовый код

#### Класс Аpi
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес
сервера и опциональный объект с заголовками запросов.
Методы:
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с
объектом, которым ответил сервер.
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и
отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию
выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего
параметра при вызове.

#### Класс Event Emitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в
системе. Класс используется в презентере для обработки событий и в слоях приложения для
генерации событий.
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в
параметрах событие

#### Класс Model
Абстрактный класс, на освнове которого можно в дальнейшем реализовывать новые модели данных.
Обеспечивает  работу с данными и взаимодействие с внешним событийным брокером.
Является дженериком. Создаёт экземпляр модели и заполняет его данными обобщенного типа.  
Конструктор:
- constructor(data: Partial<T>, protected events: IEvents) частичный объект обобщённого типа,
 который описывает конкретную модель (может быть User, Product, Order и т.д.) 
- events: IEvents, объект, реализующий интерфейс IEvents, который используется для генерации событий

#### Класс View
Абстрактный класс представления, на освнове которого можно в дальнейшем реализовывать новые компоненты.
Отрисовывает представление, обновляя его данными.
Является дженериком. Создаёт экземпляр компоненте и заполняет его данными обобщенного типа. 

Поля класса: 
- `container: HTMLElement` принимает HTML-контейнер, который будет наполняться данными и отрисовываться

Методы класса: 
- `render(data?: Partial<T>): HTMLElement` обновляет текущий экземпляр представления новыми данными обобщенного 
типа, переданными через `data` и возвращает его в виде HTMLElement-контейнера


## Слой данных

#### Класс ModelProductModel
Класс ProductModel представляет бизнес-логику интернет-магазина. Он управляет каталогом товаров, корзиной, формой заказа 
и контактными данными, а также проверяет корректность введённой информации.
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:
- _catalog: ICard[] = [] массив с объектами товаров в каталоге магазина
- _basket: string[] = [] массив с id товаров которые добавлены в корзину
- order: ICustomerData = { payment: null, address: '', email: '', phone: '' } объект, где значения это тип платежа, 
адрес, почта, телефон которые указал покупатель
- formOrderErrors: FormErrors: объект, хранящий строки ошибок для формы заказа 
- formContactsErrors: FormErrors: объект, хранящий строки ошибок для формы контакнтых данных 

Так же класс предоставляет набор методов для взаимодействия с этими данными:
- set catalog: ICard[] сеттер, сохраняет данные с сервера в каталог с объектами товаров
- getCatalogItem(id: string) ICard: получает товар по id
- get basket: string[] геттер, возвращающий массив с id товара
- get total: number: геттер, возвращающий общую стоимость корзины в виде числа
- get payment: Pick<ICustomerData, 'payment'>: данные о типе платежа картой или наличными
- get address: Pick<ICustomerData, 'address'> геттер, возвращающий адрес
- get email: Pick<ICustomerData, 'email'>` геттер, возвращающий почту
- get phone: Pick<ICustomerData, 'phone'>` геттер, возвращающий телефон
- isBasketItem(id:string): void метод, проверяющий по id наличие товара в корзине 
- addItemBasket(id:string): void метод, добавляет id товара в корзину
- removeItemBasket(id: string): void метод, удаляющий id товара из корзины 
- validateOrder(): boolean метод, проверяющий заполнение формы
- orderErrors(): string[] метод, возвращий массив строк с ошибками для формы заказа
- contactsErrors(): string[] метод, возвращий массив строк с ошибками для формы контакнтых данных
- reset(): void метод, делающий полный сброс корзины, заказа и контактов

## Слой представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент)
передаваемых в них данных. Практически все  будут иметь схожий конструктор:
- constructor(container: HTMLElement, protected events: IEvents) Конструктор принимает HTMLElement,в котором будет
отрисовывать контент с помощью метода render(), унаследованного от базового класса View.
- events:IEvents, объект, реализующий интерфейс IEvents, который используется для генерации событий

#### Класс ModalView
Реализует модальное окно и управляет его отображением: открытием, закрытием и вставкой HTML-контента.
Наследуется от базового класса View и интегрирован с системой событий приложения (IEvents). Устанавливает на клавиатуру 
слушатель для закрытия модального окна по Esc на клик в оверлей и кнопку-крестик для закрытия попапа.

Поля класса:
- _content: HTMLElement элемент модального окна в котором будет отрисовываться контент

Методы класса: 
- set content(value: HTMLElement): HTMLElement задает контент для отрисовки в _content
- open(): void открывает модальное окно и устанавливает слушатель события клавиатуры по кнопке Esc
- close(): void закрывает модальное окно и удаляет слушатель события клавиатуры по кнопке Esc
- handleEsc(evt: KeyboardEvent): oid закрывает модальное окно по нажатию кнопки Esc
- render(data: IModalData): HTMLElement открывает модальное окно и вставляет переданный HTML-контент

#### Класс PageView
Отвечает за представление и взаимодействие с основными элементами страницы: 
счётчиком корзины, блокировкой интерфейса и открытием корзины. Наследуется 
от базового класса `View<IPage>`

Поля класса:
- gallery: HTMLElement элемент разметки в котором будут рендерится карточки товаров
- _counter: HTMLElement отображающий количество товаров в корзине
- _wrapper: HTMLElement родительский элемент всего контента страницы, который блокируется при открытии модального окна
- _basket: HTMLElement кнопка по нажатию на которую, генерируется событие `basket:open`, которое откраывает корзину

Методы класса:
-	set catalog(items: HTMLElement[]): void принимает массив с элементами карточек товаров и рендерит их в элементе
разметки галереи - поле gallery
- set counter(value: number):number обновляет счетчик - отображение количества товаров в корзине
- set locked(value: boolean):void добавляет/удаляет CSS-класс блокировки интерфейса 'page__wrapper_locked'

#### Класс CardView
Общий класс, который не инстанцируется в проекте, но служит родителем для других классов. Наследуется от абстрактного класса `View<T & ICard>` 
и обогащает его функциональностью, необходимой для карточек каталога: отображение заголовка, цены и идентификатора товара.
Является дженериком, обобщение (T) позволяет расширить или дополнить интерфейс ICard, чтобы CardView мог быть повторно использован для разных типов карточек с дополнительными данными.
Полный тип передаётся как объединение T & ICard, то есть включает поля из ICard + любые дополнительные поля, описанные в T.

Поля класса:
- _id: string уникальный идентификатор товара
- _title: HTMLElement заголовок товара
- _price: HTMLElement цена товара

Методы класса:
- set id(id: string): void устанавливает значение _id для идентификации карточки (используется, например, при удалении или добавлении в корзину).
- set title(title: string):void устанавливает текст заголовка карточки в DOM-элемент _title
- set price(price: number): void устанавливает цену в DOM-элемент _price. Если цена null, отображается текст "бесценно".

#### Класс BasketItemView
Отвечает за отображение одной позиции товара в корзине и обработку её удаления. Наследуется от `CardView<IBasketItemView>`,
добавляя счётчик  и кнопки удаления.
В конструкторе создается кнопка `const button`: HTMLButtonElement, по нажатию на которую с помощью events генерируется событие 
`basketItem:delete` и передается объект с id удаляемого товара. 

Поля класса:
- _itemCounter: HTMLElement отображает позицию товара в виде порядкового номера 1,2 и т.д.

Методы класса:
- set ItemCounter(value: number):void устанавливает счетчик товара

#### Класс BasketView
Отвечает за отображение содержимого корзины, общей суммы заказа и обработку кнопки перехода к оформлению заказа. Наследуется 
от абстрактного класса `View<IBasketView>`.

Поля класса:
- _list: HTMLElement контейнер для списка товаров в корзине
- _total: HTMLElement элемент, отображающий итоговую сумму
- _button: HTMLButtonElement кнопка для перехода к оформлению заказа

Методы класса:
- set items(items: HTMLElement[]):void принимает массив элементов и заменяет содержимое корзины. Если массив пустой – отображается 
надпись «Корзина пуста» и кнопка отключается. Если товары есть – они отрисовываются, а кнопка становится активной.
- set total(total: number):void устанавливает текстовое значение общей стоимости заказа в соответствующий DOM-элемент.

#### Класс ICardCatalogView
Отвечает за тображение карточки товара в каталоге. Наследуется от базового класса `CardView`, добавляя поддержку изображения 
и визуального отображения категории товара `CardCatalogView<T> extends CardView<T & ICardCatalogView>`.
Является дженериком, обобщение (T) позволяет расширить или дополнить интерфейс ICardCatalogView, чтобы CardCatalogView мог быть повторно 
использован для разных типов карточек с дополнительными данными.

Конструктор:
- помимо контейнера и брокера событий, третим аргументом передается объект с обработчиком клика по самой карточке, этот объект содержит функцию колбэк
onClick: () => void, которая запустится если при инстанцировании класса в презентере будет передан этот третий аргумент.

Поля класса:
- _category: HTMLElement DOM-элемент категории товара
- _image: HTMLImageElement DOM-элемент для изображения товара 

Методы класса:
- set image(image: string): void устанавливает src изображения в карточке
- set category(category: string): void устанавливает текст категории, добавляет CSS-класс, соответствующий категории, из categoryMap: 
  const categoryMap = {
  'софт-скил': 'card__category_soft',
  'хард-скил': 'card__category_hard',
  'кнопка': 'card__category_button',
  'дополнительное': 'card__category_additional',
  'другое': 'card__category_other',
};

#### Класс CardPreView
Отвечает за тображение карточки товара в режиме предпросмотра
CardPreView расширяет CardCatalogView, добавляя описание, кнопку покупки и поддержку состояний товара ('Уже в корзине' и 'В корзину')

Поля класса:
- _description: HTMLElement DOM-элемент описания товара
- _buyButton: HTMLButtonElement кнопка для добавления товара в корзину. При клике на кнопку покупки 
 генерируется событие `card:buy` и передается объект с id товара

Методы класса:
- set description(description: string): void устанавливает текстовое значение описания товара
- set canBuy(value: boolean) void управляет свойством disabled у _buyButton
- set set inBasket(value: boolean): void изменяет текст кнопки: «В корзину», «Уже в корзине»

#### Класс FormView
Общий класс, который не инстанцируется в проекте, но служит родителем для других классов. Наследуется от абстрактного класса `View<IFormState>` 
и обогащает его функциональностью, необходимой для работы форм. Класс FormView<T> является дженериком, расширяет базовый View и реализует 
поведение HTML-формы: отслеживание полей ввода, отправку данных, валидацию и отображение ошибок. Тип T определяет форму данных.

Поля класса:
- _submit: HTMLButtonElement кнопка отправки формы
- _errors: HTMLElement элемент для вывода ошибок

Методы класса: 
- valid: boolean активирует или деактивирует кнопку отправки в зависимости от результата валидации
- errors: string[] выводит текст ошибок в элемент формы. Объединяет ошибки в строку через пробел методом .join(' ')
- onInputChange(field: keyof T, value: string):HTMLFormElement отправляет событие при изменении любого поля формы и передает название поля и значение
 `this.events.emit(${this.container.name}.${String(field)}:input, {field, value});`
- render(state: Partial<T> & IFormState): HTMLElement переопределяет родительский метод расширяя тип данных, устанавливая поля valid и errors, 
вызывает родительский render()

#### Класс FormOrderView 
Отвечает за сбор данных о виде оплаты заказа и адресе доставки пользователя. Наследуется от базового класса FormView<T>, реализуя поведение формы 
с выбором способа оплаты и вводом адреса. Она управляет кнопками оплаты (card / cash), адресом доставки и отправляет события при изменении данных

Поля класса:
- _address: HTMLInputElement поле ввода адреса доставки
- cardButton: HTMLButtonElement кнопка выбора оплаты картой. При клике по кнопке вызывается событие: events.emit('payment:changed', {payment: 'card'});
- cashButton : HTMLButtonElement кнопка выбора оплаты наличными. При клике по кнопке вызывается событие: events.emit('payment:changed', {payment: 'cash'});

При клике по кнопкам вызываются соответствующее событие:
events.emit('payment:changed', { payment: 'card' | 'cash' })

Методы класса:
- set address(text: string):void устанавливает текстовое значение адреса для поля ввода
- set payment(text: string):void при выборе 'card': кнопке cardButton добавляется класс button_alt-active, а у cashButton он удаляется, 
при выборе 'cash': наоборот.

#### Класс FormContactsView
Отвечает за сбор контактных данных пользователя: электронной почты и номера телефона. Наследуется от базового класса FormView<T>, что позволяет 
легко управлять состоянием валидности, ошибками и обработкой событий ввода. При вводе в поля форма автоматически отправляет события:
`formName.email:input` — при изменении email, `formName.phone:input` — при изменении телефона

Поля класса:
- _email: HTMLInputElement поле ввода электронной почты
- _phone: HTMLInputElement поле ввода номера телефона

Методы класса:
- set email(value: string): void записывает значение в поле email 
- set phone(value: string): void записывает значение в поле телефона

#### Класс SuccessView
Отвечает за ображение сообщения об успешном завершении заказа. Показывает итоговую сумму списания и предоставляет кнопку закрытия окна успеха 
"За новыми покупками!", при клике на которую генерируется событие `events.emit('order:success')`

Поля класса:
- _totalPriceDescription: HTMLParagraphElement элемент, в который подставляется итоговая сумма

Методы класса:
- set description(value: number): void устанавливает текст в описание, отображающее списанную сумму


## Коммуникационный слой 

#### Класс LarekApi
Класс LarekApi инкапсулирует запросы к серверу: получение списка товаров и отправка заказа. Построен на основе базового класса IApi.

Конструктор:
- new LarekApi(baseApi: IApi) параметры: baseApi — экземпляр базового класса Api.

Поля класса:
- _baseApi: IApi экземпляр базового класса Api

Методы класса:
- getProductList(): Promise<ApiListResponse<IProduct>> запрашивает список товаров с сервера по ендпойнту /product/ и преобразует изображения
 в формат .png, добавляя базовый путь CDN. Возвращает объект типа {items: IProduct[], total: number}
- postOrder(orderData: IOrder): Promise<ApiOrderResponse> отправляет заказ на сервер по эндпоинту /order, возвращая данные об id заказа и
итоговой стоимости


## Слой презентера. Взаимодействие компонентов
Этот модуль реализует презентер в паттерне MVP (Model-View-Presenter). Он связывает бизнес-логику (модель), 
визуальные компоненты (представления) и управляет пользовательским взаимодействием через событийную шину (EventEmitter).
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
B `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*

*События изменения данных (генерируются классами моделями данных)*
- `catalogItems:changed` - событие, генерируемое при успешной загрузке данных с сервера
- `basket:changed` - событие, генерируемое при полной очистке, добавлении, удалении товаров в корзину 
- `orderInput:changed` - событие, генерируемое при пользовательском вводе данных в инпут формы заказа
- `contactsInput:changed` - событие, генерируемое при пользовательском вводе данных в инпут формы клиентских данных

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются
классами, отвечающими за представление)*
- `card:select` - событие, генерируемое при клике по карточке товара в каталоге
- `card:buy` - событие, генерируемое при клике по кнопке 'В корзину' на карточке предпросмотра товара
- `basket:open` - событие, генерируемое при клике на корзину. Открытие корзины
- `basketItem:delete` - событие, генерируемое при клике на кнопку удаления товара  в корзине
- `order:open` - событие, генерируемое при клике на кнопку 'Оформить' в корзине
- `order:submit` - событие, генерируемое при сабмите формы заказа
- `order.address:input` - событие, генерируемое при пользовательском вводе в поле формы адреса формы заказа 
- `payment:changed` - событие, генерируемое при клике на кнопки 'Онлайн' и 'При получении'
- `contacts.email:input` - событие, генерируемое при пользовательском вводе в поле имейла формы клиентских данных 
- `contacts.phone:input` - событие, генерируемое при пользовательском вводе в поле телефона формы клиентских данных 
- `contacts:submit` - событие, генерируемое при сабмите формы клиентских данных
- `order:success` - событие, генерируемое при клике по кнопке 'За новыми покупками!' в окне успешного заказа
- `modal:open` - событие, генерируемое при клике по кнопке 'За новыми покупками!' в окне успешного заказа
- `modal:close` - событие, генерируемое при клике на кнопку закрытия модального окна, при клике вне модального окна
и нажатии клавиши Escape 

Пример работы:
- пользователь кликает по кнопке "В корзину" у карточки предпросмотра товара, на кнопке висит слушатель события клика, который 
генерирует событие 'card:buy' и передает объект с id товара `events.emit('card:buy', {id: this._id})`
- презентер перехватывает событие 'card:buy' и в модели данных добавляет товар в корзину, закрывает модальное окно в котором была 
открыта карточка предпросмотра товаров
```
events.on('card:buy', (data: {id: string}) => {
  productModel.addItemBasket(data.id);
  modal.close();
})
```
